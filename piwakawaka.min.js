const piwakawakaViewerId="image-navigator-viewer",piwakawakaLabelOverlayId="image-navigator-label-div",piwakawakaLabelOverlayClass="image-navigator-label";class Piwakawaka{constructor(a,b,c){this._playCallback=b,this._stopCallback=c,this._fillViewer=Piwakawaka.defaultFillViewer,this._speedFactor=Piwakawaka.defaultSpeedFactor,this._springStiffness=Piwakawaka.defaultSpringStiffness,this._fullscreenViewer=!0,this._sequenceStep=0,this._paused=!0,this._conditions=void 0,this.initConditions(),this._viewerDiv=document.createElement("div"),this._viewerDiv.setAttribute("id",piwakawakaViewerId),this._viewerDiv.style.visibility="hidden",document.body.appendChild(this._viewerDiv),this._overlayElement=document.createElement("div"),this._overlayElement.id=piwakawakaLabelOverlayId,this._overlayElement.className=piwakawakaLabelOverlayClass,this.init(a),this._viewer=void 0,this.initViewer(),this._noSleep=new NoSleep}init(a){console.log("Init P\u012Bwakawaka navigator object",a);void 0===a||null==a||(null!=a.image&&this.setImageLocation(a.image),null!=a.speed&&this.setSpeedFactor(a.speed),null!=a.fillViewer&&this.setFillViewer(a.fillViewer),null!=a.crop&&this.setCrop(a.crop[0],a.crop[1],a.crop[2],a.crop[3]),null!=a.sequence&&this.setSequence(a.sequence),this._previousConfig=this._config,this._config=a,this._sequenceStep=0)}initConditions(){this._conditions={overEdge:!1}}setImageLocation(a){void 0==a||null==a||(this._imageLocation=a)}setSequence(a){"array"!=$.type(a)&&console.log("ERROR: sequence is not an array"),this._sequence=a}setCrop(a,b,c,d){return null==a||null==b||null==c||null==d?void(this._crop=null):void(this._crop={x:a,y:b,width:c,height:d})}setFullscreen(a){this._fullscreenViewer=a}setFillViewer(a){this._fillViewer=a}setSpeedFactor(a){this._speedFactor=a}applySpringStiffness(){this._viewer.viewport.centerSpringX.springStiffness=this._springStiffness,this._viewer.viewport.centerSpringY.springStiffness=this._springStiffness,this._viewer.viewport.zoomSpring.springStiffness=this._springStiffness}applyAnimationDuration(a){a/=this._speedFactor,0>this._speedFactor&&(a=0),this._viewer.viewport.centerSpringX.animationTime=a,this._viewer.viewport.centerSpringY.animationTime=a,this._viewer.viewport.zoomSpring.animationTime=a}getCurrentViewportVisibleRegion(){return this._viewer.viewport.getBounds()}getCurrentImageVisibleRegion(){let a=this._viewer.viewport.viewportToImageRectangle(this._viewer.viewport.getBounds());return new OpenSeadragon.Rect(Math.round(a.x),Math.round(a.y),Math.round(a.width),Math.round(a.height))}play(a=0){console.log("PLAY sequence",this._sequence),this._viewerDiv.style.visibility="visible",-1<a&&(this._sequenceStep=a),this._paused=!1,this._fullscreenViewer&&(this._viewer.setFullScreen(!0),this._noSleep.enable()),0>a?(console.log("resume location "+this._sequenceStep,this._imageVisibleRect),this.applyMoveTo(this._imageVisibleRect.x,this._imageVisibleRect.y,this._imageVisibleRect.width,this._imageVisibleRect.height,null,0)):(this.initConditions(),this.initViewer(this._imageLocation)),this._viewer.addHandler("open",this.doNextSequenceAction.bind(this)),this._playCallback&&this._playCallback(this)}resume(){console.log("RESUMING"),this.play(-1)}stop(){console.log("PAUSED"),this._paused=!0,this._viewer.setFullScreen(!1),this._noSleep.disable(),this._viewerDiv.style.visibility="hidden",this._stopCallback&&this._stopCallback(this)}doNextSequenceAction(){if((console.log("Do action, paused="+this._paused),!this._paused)&&(this._sequenceStep++,console.log("Next action "+this._sequenceStep+" of "+this._sequence.length),this._sequence))if(this._sequenceStep<=this._sequence.length){let a=this._sequence[this._sequenceStep-1];(null==a.delay||0>a.delay)&&(a.delay=0),console.log("action (delay:"+a.delay+")",a),0<a.delay?(this._paused=!0,setTimeout(function(){this.applyMoveTo(a.x,a.y,a.width,a.height,a.label,a.duration,a.speed,a.spring,a.skip),this._paused=!1}.bind(this),1e3*a.delay)):this.applyMoveTo(a.x,a.y,a.width,a.height,a.label,a.duration,a.speed,a.spring,a.skip)}else this.stop()}applyMoveTo(a,b,c,d,e,f,g,h,i){this._viewer.removeOverlay(piwakawakaLabelOverlayId);let j=this.getCurrentViewportVisibleRegion();this._imageVisibleRect=this.getCurrentImageVisibleRegion();let k=this._speedFactor,l=this._springStiffness;console.log("imageSource: "+this._viewer.source.width+","+this._viewer.source.height),console.log("move from: "+this._imageVisibleRect.x+","+this._imageVisibleRect.y+" ("+this._imageVisibleRect.width+"x"+this._imageVisibleRect.height+")");let m=this.commandToImagePixel(a),n=this.commandToImagePixel(b,"y");c=this.commandToImagePixel(c),d=this.commandToImagePixel(d,"y");let o=!1;if(("prev"==a||"next"==a)&&m==this._imageVisibleRect.x&&(o=!0),("prev"==b||"next"==b)&&n==this._imageVisibleRect.y&&(o=!0),!1==this._conditions.overEdge&&(this._conditions.overEdge=o),this._conditions.overEdge&&"overEdge"==i)return console.log("Skip step as over the edge"),void this.doNextSequenceAction();null==c&&(c=this._imageVisibleRect.width),null==d&&(d=this._imageVisibleRect.height);let p=Piwakawaka.calcDirectDistance(this._imageVisibleRect.x,this._imageVisibleRect.y,m,n),q=p/Piwakawaka.defaultSpeedWebPixelsPerSecond;null!=g&&this.setSpeedFactor(g),null!=h&&this.applySpringStiffness(h),f&&(q=f,this.setSpeedFactor(1)),this.applyAnimationDuration(q);let r=this._viewer.viewport.imageToViewportCoordinates(m,n),s=this._viewer.viewport.imageToViewportCoordinates(c,d);j.x=r.x,j.y=r.y,j.width=s.x,j.height=s.y,console.log("move to  : "+m+","+n+" ("+c+"x"+d+") web-dist:"+p+" secs:"+q),console.log("viewportVisibleRect",j);let t=!1;-1==g&&(t=!0),this._viewer.viewport.fitBoundsWithConstraints(j,t),null!=e&&(this._overlayElement.innerHTML=e,this._viewer.addOverlay({element:this._overlayElement,location:new OpenSeadragon.Point(0.21,0.2),placement:OpenSeadragon.Placement.CENTER})),this.setSpeedFactor(k),this.applySpringStiffness(l)}commandToImagePixel(a,b){let c=this._viewer.source;this._imageVisibleRect=this.getCurrentImageVisibleRegion();let d=0,e=c.width,f=this._imageVisibleRect.x,g=this._imageVisibleRect.width;switch(null!=this._crop&&(d=this._crop.x,e=this._crop.x+this._crop.width),"y"===b&&(e=c.height,f=this._imageVisibleRect.y,g=this._imageVisibleRect.height,null!=this._crop&&(d=this._crop.y,e=this._crop.y+this._crop.height)),a){case"min":case"minimum":a=d;break;case"max":case"maximum":a=e;break;case"same":a=f;break;case"next":a=f+g;let h=e-g;a>h&&(a=h);break;case"prev":case"previous":a=f-g,0>a&&(a=0);}return a}initViewer(a){if(console.log("init viewer: "+a),this._viewer){console.log("updating OSD viewer to new image");let e=this._fillViewer?1:0,f=this._fillViewer?1:0;return this._viewer.defaultZoomLevel=0,this._viewer.minZoomLevel=0,void this._viewer.open(a)}console.log("creating OSD viewer");let b={scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!1,pinchToZoom:!1,pinchRotate:!1,flickEnabled:!1},c=this._fillViewer?1:0,d=this._fillViewer?1:0;this._viewer=OpenSeadragon({id:piwakawakaViewerId,prefixUrl:"https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.3.1/images/",tileSources:a,crossOriginPolicy:"Anonymous",minZoomLevel:c,defaultZoomLevel:d,sequenceMode:!0,visibilityRatio:1,constrainDuringPan:!0,gestureSettingsMouse:b,gestureSettingsTouch:b,gestureSettingsPen:b,gestureSettingsUnknown:b,panHorizontal:!1,panVertical:!1,showNavigationControl:!0,autoHideControls:!0,showZoomControl:!1,showHomeControl:!1,showSequenceControl:!1,showRotationControl:!1,showFullPageControl:!1}),null==this._stopButton&&(this._stopButton=new OpenSeadragon.Button({tooltip:"Close",srcRest:"https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.3.1/images/previous_rest.png",srcGroup:"https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.3.1/images/previous_grouphover.png",srcHover:"https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.3.1/images/previous_hover.png",srcDown:"https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.3.1/images/previous_pressed.png",onClick:this.stop.bind(this),fadeDelay:5e3,fadeLength:2e3}),this._viewer.addControl(this._stopButton.element,{anchor:OpenSeadragon.ControlAnchor.BOTTOM_LEFT})),this._viewer.addHandler("animation-finish",this.doNextSequenceAction.bind(this)),this._viewer.addHandler("full-screen",this.fullscreenEventHandler.bind(this))}fullscreenEventHandler(a){!1==a.fullScreen&&this.stop()}getViewer(){return this._viewer}static calcDirectDistance(a,b,c,d){let e=Math.abs(c-a),f=Math.abs(d-b),g=Math.round(Math.sqrt(Math.pow(e,2)+Math.pow(f,2)));return g}static getParameterByName(a,b){b===void 0&&(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");let c=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)"),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null}}Piwakawaka.defaultSpeedWebPixelsPerSecond=10,Piwakawaka.defaultFillViewer=!0,Piwakawaka.defaultSpeedFactor=10,Piwakawaka.defaultSpringStiffness=1;
